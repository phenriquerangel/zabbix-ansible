---
- name: Configurar servidores PostgreSQL
  hosts: postgres_servers
  vars_files:
    - vars.yml 
  tasks:
    - name: Instalar PostgreSQL e TimescaleDB
      apt:
        name: ['postgresql', 'postgresql-contrib', 'timescaledb-postgresql']

    - name: Configurar PostgreSQL
      template:
        src: postgresql.conf.j2
        dest: /etc/postgresql/{{ postgres_version }}/main/postgresql.conf
      notify: Restart PostgreSQL

    - name: Configurar TimescaleDB
      command: sudo -u postgres psql -d {{ db_name }} -c "CREATE EXTENSION IF NOT EXISTS timescaledb;"
      notify: Restart PostgreSQL

    - name: Configurar replicação
      template:
        src: pg_hba.conf.j2
        dest: /etc/postgresql/{{ postgres_version }}/main/pg_hba.conf
      notify: Restart PostgreSQL

    - name: Criar diretório de dados
      file:
        path: /data
        state: directory
        owner: postgres
        group: postgres

  handlers:
    - name: Restart PostgreSQL
      service:
        name: postgresql
        state: restarted
